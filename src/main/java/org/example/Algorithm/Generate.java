package org.example.Algorithm;

import org.example.General;
import org.example.VKData.UserDB;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.TreeSet;

public class Generate {
    public static TreeSet<Integer> getGenerateUserIds(int id, int indexGenerate, int index, long date) throws InterruptedException {
        General.lock.lock1();
        TreeSet<Integer> set = General.generateIds[indexGenerate].get(id);
        TreeSet<Integer> buffer = new TreeSet<>();

        for (int element : set) {
            UserDB userDB = General.users.get(element);
            if (userDB.iDsHistories == null) continue;
            if (userDB.iDsHistories[index] == null) continue;
            TreeSet<Integer> temp = userDB.iDsHistories[index].get(date);
            if (temp == null) continue;
            if (temp.contains(id)) buffer.add(element);
        }

        General.lock.unlock1();
        if (buffer.isEmpty()) return null;
        return buffer;
    }

    public TreeSet<Integer> getGeneralGenerate(int indexGenerate, ArrayList<Integer> ids) throws InterruptedException {
        General.lock.lock1();
        TreeSet<Integer> temp = General.generateIds[indexGenerate].get(ids.getFirst());
        if (temp == null) return null;
        TreeSet<Integer> buffer = new TreeSet<>(temp);

        for (int index = 1; index < ids.size(); ++index) {
            temp = General.generateIds[indexGenerate].get(ids.get(index));
            if (temp == null) return null;
            buffer.retainAll(temp);
        }

        General.lock.unlock1();
        return ((buffer.isEmpty()) ? null : buffer);
    }

    public static ArrayList<Integer> getGeneral(int[][] data) {
        int ind = 0;
        for (int index = 1; index < data.length; ++index)
            if (data[index].length < data[ind].length) ind = index;

        int[] temp = data[ind];
        data[ind] = data[0];
        data[0] = temp;

        ArrayList<Integer> buffer = new ArrayList<>(data[0].length);
    q:  for (int element : data[0]) {
            for (int index = 1; index < data.length; ++index)
                if (Arrays.binarySearch(data[index], element) < 0)
                    continue q;
            buffer.add(element);
        } return (buffer.isEmpty()) ? null : buffer;
    }

    public static ArrayList<Integer> getGeneralUserIds(ArrayList<Integer> data, int indexIds) throws InterruptedException {
        int[][] buffer = new int[data.size()][];
        int index = 0;

        General.lock.lock1();
        for (int element : data) {
            UserDB userDB = General.users.get(element);
            if (userDB == null) return null;
            if (userDB.iDsHistories == null) return null;
            if (userDB.iDsHistories[indexIds] == null) return null;
            int[] temp = userDB.iDsHistories[indexIds].last.data;
            if (temp == null) return null;
            buffer[index++] = temp;
        }

        General.lock.unlock1();
        return getGeneral(buffer);
    }
}
